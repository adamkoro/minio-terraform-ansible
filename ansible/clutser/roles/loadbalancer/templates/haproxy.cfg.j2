global
    log /dev/log daemon
    maxconn 32768
    chroot /var/lib/haproxy
    user haproxy
    group haproxy
    daemon
    stats socket /var/lib/haproxy/stats user haproxy group haproxy mode 0640 level operator
    tune.bufsize 32768
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ALL:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK:!RC4:!ADH:!LOW@STRENGTH

defaults
    log     global
    mode    http
    option  log-health-checks
    option  log-separate-errors
    option  dontlog-normal
    option  dontlognull
    option  httplog
    option  socket-stats
    retries 3
    option  redispatch
    maxconn 10000
    timeout connect     5s
    timeout client     5s
    timeout server    10s

frontend http_frontend
    bind *:80
    mode http
    redirect scheme https code 301 if !{ ssl_fc }

frontend https_frontend
    bind *:443 ssl crt {{ haproxy_cert_path }}
    mode tcp
    acl host_minio req.ssl_sni -i https://{{ haproxy_url }}
    acl host_minio_console req.ssl_sni -i https://{{ haproxy_console_url }}
    use_backend minio_backend if host_minio
    use_backend minio_console_backend if host_minio_console
    stats enable
    stats uri /stats
    stats refresh 5s

backend minio_backend
    mode tcp
    balance leastconn
{% for host in groups['minio'] %}
{% set minio_number = loop.index %}
{% set minio_prefix = 'minio' + '-' + minio_number|string %}
    server {{ minio_prefix }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:9000 check inter 1s
{% endfor %}

backend minio_console_backend
    mode tcp
    balance leastconn
{% for host in groups['minio'] %}
{% set minio_number = loop.index %}
{% set minio_prefix = 'minio' + '-' + minio_number|string %}
    server {{ minio_prefix }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:{{ minio_console_port }} check inter 1s
{% endfor %}